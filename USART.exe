
地址标记: 
可为本机配置一个本机地址(4位),并将接收器进入静默状态.此时,接收器会将最高位为'1'的数据识别为"地址",最高位为'0'的识别为数据.当接收器接收到一个"地址"时,会对此"地址"进行判断:低4位是否与"本机地址匹配",若匹配,则接收接下来的"数据",直到下一次"地址"的到来,而接下来的"地址"匹配,则继续接收,若不匹配,则重新进入静默状态.地址标记模式的使用在多处理器通信且大数据吞吐中,能有效地利用硬件的筛选减少CPU的运行. 但是,由于地址标志模式仅适用于同一条串口总线中一主多从的情况,使用上较为繁琐,不适用于常规的使用场合,而且地址标志模式会加大驱动的复杂程度,在代码兼容性以及可移植性方面并没有优势,所以地址模式需要根据实际的应用来配置.
已知缺陷: 
1) 地址标记模式中,当接收数据完成后,空闲帧的到来并不会触发"空闲帧"中断,这样会使UART的可用性降低
2) 地址标记模式中,由于是对最高位进行对数据分类(区分是地址还是数据数据),导致最高位的使用受到了限制.
避免方法: 
开启"接收缓冲区非空中断",这样子"地址"字符匹配之后便会触发此中断,在此中断内暂时关闭接收器静默状态,在触发空闲帧中断后再开启静默状态.


USART的DMA传输:
相对于CPU的运算时间,USART的数据传输速度很慢,如果需要利用CPU去逐位数据传输,则浪费了MCU大好的性能.如果是用于做实验或者是简单的应用,这些性能的损耗还是可以接受,但是如果是应用到产品之中,则实在不妥.在常规的开发中,USART的应用一般是利用其发送完成中断(发送缓冲区空标志触发)以及接收中断(接收缓冲区非空标志触发)来进行对数据的传输,但是STM32自带了17个通道的DMA,我们可以的利用其DMA进行更高效的应用.
以DMA发送为例,如果要利用USART的DMA传输,则需要使能其USART的DMA传输使能位(USART_CR3_DMAT),这样子,当其条件满足(接收缓冲区非空,TXE被触发),则DMA会从指定的地方(SRAM区域)搬运数据到USART_DR寄存器中,此时CPU可以执行其他的任务,把这些数据的搬运工作交由硬件.其USART的DMA通道配置流程如下:
1) 确定当前USART的DMA通道号以及是哪个DMA,并开启其外设时钟
2) 根据实际的应用场合来配置其工作模式,在USART发送DMA的配置中,内存传输模式需要设置为外设-内存模式,优先级可以根据情况来选择(为了保证CPU有足够的带宽去执行其他任务,这里配置为中等优先级),内存和外设都数据帧都选择8位数据帧,内存地址增量而外设地址固定,非循环发送,开启传输完成中断等等
3) 配置其DMA的目的地址(USART_DR寄存器)和源地址(要发送的数据的地址,SRAM区域),以及一次要发送的数量.
DMA传输栈区数据的缺陷:
假如外部函数调用此DMA发送函数,入参的缓冲区是栈上的局部变量,那么在外部函数结束后栈上的空间被回收(此时USART还在发送中).如果此时在别的函数中修改了栈上的数据,串口的发送便是无效的数据.故而修改其发送机制,在发送函数中,将栈上临时存储的数据复制到堆上的空间中,用链表的方式链接多个发送缓冲区.这样子,当USART还在发送过程中而CPU已经在外面执行别的任务,也不会因为栈区的改变而导致其传输数据的紊乱.当DMA发送完成后,在DMA发送完成中断中判断当前是否是链表的最后一个节点以确认是否还需要继续发送数据,如果是则释放其申请的空间并退出,否则则在释放空间后继续利用DMA发送下一个链表节点的数据.做过传输速度的验证,以115200波特率速率下发送40K数据为例,只要堆上可用的空间足够,CPU的占用也不超过2MS.如果是常规的发送,则需要占用CPU3.56S的运算时间,性能提升约1800倍,极为明显!


系统调试记录:
1) USART在初始化阶段Tx脚产生一个负脉冲(此负脉冲会被识别为一个字符).原因是在配置IO口为复用模式后,由于此时UART的时钟尚未开启,所以电平被拉低.紧接着,开启UART的时钟并且使能发送功能后,IO通电,恢复高电平,故而整体为一个负脉冲,并可被识别为一个字符(0X80,0XFF,0XFE等).
2) 利用DMA去发送一组串口数据,当触发"DMA传输完成(TCIF)"条件后关闭串口发送功能,使用示波器发现串口只发送了一部分的数据.根据 STM32参考手册(Rev 16) 818页 Figure 296 可知,DMA搬运完成即触发"TCIF"标志,而此时最后的数据存于移位寄存器中,串口的发送尚未完成,关闭串口会对尚在发送的数据造成截断.若要解决此BUG,可以把DMA发送的完成标志判断由"DMA_TCIF"改成"USART_TC".
































